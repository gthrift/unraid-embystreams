Menu="Dashboard:0"
Icon="emby.png"
Tag="film"
Cond="parse_ini_file('/boot/config/plugins/embystreams/embystreams.cfg')['DISPLAY_WIDGET'] == '1'"
---
<?php
    $plugin = "embystreams";
    $cfg = parse_ini_file("/boot/config/plugins/embystreams/embystreams.cfg");
    $poll_interval = isset($cfg['POLL_INTERVAL']) ? (int)$cfg['POLL_INTERVAL'] * 1000 : 5000;
    
    // Construct Emby WebUI URL
    $host = $cfg['HOST'] ?? '';
    $port = $cfg['PORT'] ?? '8096';
    $protocol = ($port == '8920') ? 'https' : 'http';
    $emby_url = "$protocol://$host:$port/web/index.html";
?>

<style>
    .emby-icon-img { width: 35px; height: 35px; vertical-align: top; margin-right: 10px; }
    .es-row { display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 4px 0; }
    .es-row:last-child { border-bottom: none; }
    .es-transcode { font-size: 10px; opacity: 0.7; margin-left: 5px; }
</style>

<?php
$mytiles[$plugin]['column1'] =
<<<EOT
<tbody class="sortable" title="_(Emby Streams)_">
    <tr>
        <td>
            <img src="/plugins/embystreams/emby.png" class="emby-icon-img icon">
            
            <div class="section" style="line-height:2rem;">
                _(Emby Streams)_<br>
                <span id="es_count_container"><span id="embystreams_count">0</span> _(Active Stream(s))_</span>
            </div>
            
            <span style="float:right; margin-top: 12px;">
                <a href="{$emby_url}" target="_blank" title="_(Open Emby WebUI)_" style="margin-right: 8px;">
                    <i class="fa fa-fw fa-external-link control"></i>
                </a>
                <a href="/Settings/EmbyStreamsSettings" title="_(Settings)_">
                    <i class="fa fa-fw fa-cog control"></i>
                </a>
            </span>
        </td>
    </tr>
    <tr>
        <td>            
            <span class="w36">_(Name)_</span>
            <span class="w18" align="center">_(Device)_</span>
            <span class="w18">_(User)_</span>
            <span class="w18" align="right">_(State)_</span>
        </td>
    </tr>
    <tr>
        <td>
            <div id="embystreams_streams">
                <div id="es_retrieving">
                    <p align="center" style="font-style:italic;text-align:center;padding-top:10px;">_(Retrieving Data...)_</p>
                </div>
            </div>
        </td>
    </tr>
</tbody>
EOT;
?>

<script>
    var embyPollInterval = <?=$poll_interval;?>;
    
    function updateEmbyDashboard() {
        $.get("/plugins/embystreams/embystreams_api.php", function(data) {
            if (data) {
                // 1. Update the stream list content
                $("#embystreams_streams").html(data);
                
                // 2. Calculate the count
                // We count how many elements have the class '.es-row'
                var count = $("#embystreams_streams .es-row").length;
                
                // Double check: if the HTML contains the "No active streams" text, force count to 0
                if(data.indexOf("No active streams") !== -1) {
                    count = 0;
                }
                
                // 3. Update the text number
                $("#embystreams_count").text(count);
            }
        });
    }

    $(function() {
        // Run immediately
        updateEmbyDashboard();
        // Start Polling
        setInterval(updateEmbyDashboard, embyPollInterval);
    });
</script>
