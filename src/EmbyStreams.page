Menu="Dashboard:0"
Icon="emby.png"
Tag="film"
---
<?php
    if (session_status() === PHP_SESSION_NONE) { session_start(); }
    if (empty($_SESSION['embystreams_csrf'])) { $_SESSION['embystreams_csrf'] = bin2hex(random_bytes(32)); }
    
    $plugin = "embystreams";
    $cfg = parse_ini_file("/boot/config/plugins/embystreams/embystreams.cfg");
    
    $poll_interval = isset($cfg['POLL_INTERVAL']) ? max(1, min(60, (int)$cfg['POLL_INTERVAL'])) * 1000 : 5000;
    $host = $cfg['HOST'] ?? '';
    $port = max(1, min(65535, (int)($cfg['PORT'] ?? 8096)));
    $use_https = ($cfg['USE_HTTPS'] ?? '0') === '1';
    $protocol = $use_https ? 'https' : 'http';
    $emby_url = htmlspecialchars("$protocol://$host:$port/web/index.html", ENT_QUOTES, 'UTF-8');
    $csrf_token = $_SESSION['embystreams_csrf'];
?>

<style>
    /* 1. Icon Styling */
    .emby-icon-img { 
        width: 32px; 
        height: 32px;
        object-fit: contain;
    }

    /* 2. Container Constraint */
    #embystreams-dashboard-card {
        width: 100%;
        max-width: 100%;
    }

    /* 3. Row Styling */
    .es-row { 
        display: flex;
        align-items: center;
        width: 100%;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        padding: 4px 0;
        box-sizing: border-box;
    }
    .es-row:last-child { border-bottom: none; }

    /* 4. Text Truncation Base */
    .es-row > span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* 5. FLEX COLUMN SIZING (The Fix) */
    
    /* NAME: flex: 1 means "take whatever space is left"
       min-width: 0 means "you can shrink smaller than your text" */
    .es-name { 
        flex: 1 1 auto; 
        min-width: 0; 
        padding-right: 10px;
    }

    /* OTHERS: Fixed flex basis ensures they retain their size */
    .es-device { flex: 0 0 25%; text-align: center; }
    .es-user   { flex: 0 0 15%; text-align: center; }
    .es-state  { flex: 0 0 20%; text-align: right; }

    /* --- MOBILE OVERRIDES --- */
    @media only screen and (max-width: 600px) {
        .es-device, .es-user { display: none !important; }
        .es-name { flex: 1; }
        .es-state { flex: 0 0 auto; margin-left: auto; padding-left: 10px; }
    }
</style>

<?php
$mytiles[$plugin]['column1'] = <<<EOT
<tbody class="sortable" title="_(Emby Streams)_">
  <tr>
    <td id='{$plugin}-dashboard-card'>
      <span class='tile-header'>
        <span class='tile-header-left'>
          <img src="/plugins/embystreams/emby.png" class="emby-icon-img">
          <div class='section'>
            <h3 class='tile-header-main'>_(Emby Streams)_</h3>
            <span id="es_count_container">
                <span id="embystreams_count">0</span> _(Active Stream(s))_
            </span>
          </div>
        </span>
        <span class='tile-header-right'>
           <span class='tile-header-right-controls'>
              <a href="{$emby_url}" target="_blank" title="_(Open Emby WebUI)_">
                <i class="fa fa-fw fa-external-link"></i>
              </a>
              <a href="/Settings/EmbyStreamsSettings" title="_(Settings)_">
                <i class="fa fa-fw fa-cog"></i>
              </a>
           </span>
        </span>
      </span>
    </td>
  </tr>

  <tr>
    <td>
        <div class="es-row" style="font-weight:bold; opacity:0.7; font-size:0.9em;">
            <span class="es-name">_(Name)_</span>
            <span class="es-device">_(Device)_</span>
            <span class="es-user">_(User)_</span>
            <span class="es-state">_(State)_</span>
        </div>
        
        <div id="embystreams_streams">
            <div id="es_retrieving">
                 <p align="center" style="font-style:italic; padding-top:10px;">_(Retrieving Data...)_</p>
            </div>
        </div>
    </td>
  </tr>
</tbody>
EOT;

// COMPATIBILITY BLOCK
$isResponsiveWebgui = version_compare(parse_ini_file('/etc/unraid-version')['version'] ?? "", '7.2', '>=');
if ( ! $isResponsiveWebgui) {
    $mytiles[$plugin]["column1"] .= "<script>console.log('EmbyStreams: Legacy Mode Active');</script>";
}
?>

<script>
    var embyPollInterval = <?=$poll_interval;?>;
    var embyCsrfToken = "<?=htmlspecialchars($csrf_token, ENT_QUOTES, 'UTF-8');?>";
    var embyLastUpdate = 0;
    var embyMinInterval = 1000;
    
    function updateEmbyDashboard() {
        var now = Date.now();
        if (now - embyLastUpdate < embyMinInterval) return;
        embyLastUpdate = now;
        
        $.ajax({
            url: "/plugins/embystreams/embystreams_api.php",
            method: "GET",
            headers: { "X-CSRF-Token": embyCsrfToken },
            timeout: 5000,
            success: function(data) {
                if (data) {
                    $("#embystreams_streams").html(data);
                    var count = $("#embystreams_streams .es-row").length;
                    if(data.indexOf("No active streams") !== -1) { count = 0; }
                    $("#embystreams_count").text(count);
                }
            },
            error: function(xhr, status, error) {
                $("#embystreams_streams").html("<div style='padding:15px; text-align:center; color:#d44;'>_(Connection Error)_</div>");
            }
        });
    }

    $(function() {
        updateEmbyDashboard();
        setInterval(updateEmbyDashboard, embyPollInterval);
    });
</script>
