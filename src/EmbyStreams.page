Menu="Dashboard:0"
Icon="emby.png"
Tag="film"
Cond="parse_ini_file('/boot/config/plugins/embystreams/embystreams.cfg')['DISPLAY_WIDGET'] == '1'"
---
<?php
    $plugin = "embystreams";
    $cfg = parse_ini_file("/boot/config/plugins/embystreams/embystreams.cfg");
    $poll_interval = isset($cfg['POLL_INTERVAL']) ? (int)$cfg['POLL_INTERVAL'] * 1000 : 5000;
    
    // Construct Emby WebUI URL
    $host = $cfg['HOST'] ?? '';
    $port = $cfg['PORT'] ?? '8096';
    $protocol = ($port == '8920') ? 'https' : 'http';
    $emby_url = "$protocol://$host:$port/web/index.html";
?>

<style>
    /* Icon styling adjusted for tile-header */
    .emby-icon-img { width: 32px; height: 32px; } 

    /* Standard Row Styling (Desktop) */
    /* We apply this to both the Header and the Data rows so they align perfectly */
    .es-row, .es-header-row { 
        display: flex; 
        align-items: center; 
        width: 100%;
    }
    
    .es-row { 
        border-bottom: 1px solid rgba(255,255,255,0.05); 
        padding: 4px 0; 
    }
    .es-row:last-child { border-bottom: none; }
    .es-transcode { font-size: 10px; opacity: 0.7; margin-left: 5px; }

    /* --- Mobile Responsive Rules --- */
    @media only screen and (max-width: 500px) {
        
        /* 1. Hide Device and User columns */
        .es-hide-mobile { 
            display: none !important; 
        }
        
        /* 2. NAME Column (First Item)
           flex: 1 -> Forces this element to grow and consume ALL empty space.
           This pushes the State column to the far right. */
        .es-header-row > span:first-child,
        .es-row > span:first-child { 
            flex: 1 1 auto !important;
            width: auto !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 3. STATE Column (Last Item)
           flex: 0 0 70px -> Do not grow, do not shrink, stay exactly 70px wide. */
        .es-header-row > span:last-child,
        .es-row > span:last-child { 
            flex: 0 0 70px !important;
            width: 70px !important; 
            text-align: right !important;
        }
    }
</style>

<?php
$mytiles[$plugin]['column1'] = <<<EOT
<tbody class="sortable" title="_(Emby Streams)_">
  <tr>
    <td>
      <div class='tile-header' id='{$plugin}-dashboard-card'>
        <div class='tile-header-left'>
          <img src="/plugins/embystreams/emby.png" class="emby-icon-img icon">
          <div class='section'>
            <h3 class='tile-header-main' id='{$plugin}-dashboard-title'>
              _(Emby Streams)_
            </h3>
            <span id="es_count_container"><span id="embystreams_count">0</span> _(Active Stream(s))_</span>
          </div>
        </div>
        <div class='tile-header-right'>
          <div class='tile-header-right-controls'>
            <a href="{$emby_url}" target="_blank" title="_(Open Emby WebUI)_">
              <i class="fa fa-fw fa-external-link control"></i>
            </a>
            <a id="{$plugin}-settings-button" href="/Settings/EmbyStreamsSettings" title="_(Settings)_">
              <i class="fa fa-fw fa-cog control"></i>
            </a>
          </div>
        </div>
      </div>
    </td>
  </tr>
  <tr>
    <td>            
        <div class="es-header-row">
            <span class="w36">_(Name)_</span>
            <span class="w18 es-hide-mobile" align="center">_(Device)_</span>
            <span class="w18 es-hide-mobile">_(User)_</span>
            <span class="w18" align="right">_(State)_</span>
        </div>
    </td>
  </tr>
  <tr>
    <td>
        <div id="embystreams_streams">
            <div id="es_retrieving">
                <p align="center" style="font-style:italic;text-align:center;padding-top:10px;">_(Retrieving Data...)_</p>
            </div>
        </div>
    </td>
  </tr>
</tbody>
EOT;

// COMPATIBILITY BLOCK FOR UNRAID 7.2+
$isResponsiveWebgui = version_compare(parse_ini_file('/etc/unraid-version')['version'] ?? "", '7.2', '>=');
if ( ! $isResponsiveWebgui) {
    $mytiles[$plugin]["column1"] .= <<<EOT
        <script>
            $(function() {
                $('#{$plugin}-dashboard-title').replaceWith(function() {
                    return $(this).text() + "<br>";
                });
                $('#{$plugin}-settings-button').prependTo('#{$plugin}-dashboard-card');
            });
        </script>
    EOT;
}
?>

<script>
    var embyPollInterval = <?=$poll_interval;?>;
    
    function updateEmbyDashboard() {
        $.get("/plugins/embystreams/embystreams_api.php", function(data) {
            if (data) {
                // 1. Update list
                $("#embystreams_streams").html(data);
                
                // 2. Update count
                var count = $("#embystreams_streams .es-row").length;
                if(data.indexOf("No active streams") !== -1) { count = 0; }
                $("#embystreams_count").text(count);
            }
        });
    }

    $(function() {
        updateEmbyDashboard();
        setInterval(updateEmbyDashboard, embyPollInterval);
    });
</script>
