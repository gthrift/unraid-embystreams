Menu="EmbyStreams"
Title="Emby Stream Settings"
Tag="film"
---
<?php
    // Initialize session for CSRF protection
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }
    
    // Generate CSRF token if not exists
    if (empty($_SESSION['embystreams_csrf'])) {
        $_SESSION['embystreams_csrf'] = bin2hex(random_bytes(32));
    }
    
    $plugin = "embystreams";
    $translations = file_exists("$docroot/webGui/include/Translations.php");
?>
<?if (!$translations):?>
    <div style="padding: 20px;">Please update Unraid to use this plugin.</div>
<?else:?>
---
<style>
    .lds-dual-ring { display: inline-block; width: 16px; height: 16px; }
    .lds-dual-ring:after { content: " "; display: block; width: 12px; height: 12px; margin: 1px; border-radius: 50%; border: 2px solid #fff; border-color: #000 transparent #000 transparent; animation: lds-dual-ring 1.2s linear infinite; }
    @keyframes lds-dual-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-message { color: #d44; padding: 10px; margin: 10px 0; border: 1px solid #d44; background: rgba(221, 68, 68, 0.1); border-radius: 4px; }
    .success-message { color: #8cc43c; padding: 10px; margin: 10px 0; border: 1px solid #8cc43c; background: rgba(140, 196, 60, 0.1); border-radius: 4px; }
</style>

<?php
// Load Config
$cfg_file = "/boot/config/plugins/embystreams/embystreams.cfg";
$cfg = parse_ini_file($cfg_file);

// Set Defaults
if (!isset($cfg['DISPLAY_WIDGET'])) { $cfg['DISPLAY_WIDGET'] = "1"; }
if (!isset($cfg['DISPLAY_NAV'])) { $cfg['DISPLAY_NAV'] = "1"; }
if (!isset($cfg['HOST'])) { $cfg['HOST'] = ""; }
if (!isset($cfg['PORT'])) { $cfg['PORT'] = "8096"; }
if (!isset($cfg['API_KEY'])) { $cfg['API_KEY'] = ""; }
if (!isset($cfg['POLL_INTERVAL'])) { $cfg['POLL_INTERVAL'] = "5"; }
if (!isset($cfg['USE_HTTPS'])) { $cfg['USE_HTTPS'] = "0"; }

// Validate and sanitize loaded config
$cfg['PORT'] = max(1, min(65535, (int)$cfg['PORT']));
$cfg['POLL_INTERVAL'] = max(1, min(60, (int)$cfg['POLL_INTERVAL']));

// Secure plugin path handling
$pluginPath = realpath('/usr/local/emhttp/plugins/embystreams/');
if ($pluginPath === false || !is_dir($pluginPath)) {
    echo "<div class='error-message'>Plugin directory not found. Please reinstall the plugin.</div>";
    exit;
}
$pluginPath .= '/';

// Logic to Hide/Show Tabs based on settings (Mirrors PlexStreams behavior)
// 1. Toggle the Main Navigation Tab
if ($cfg['DISPLAY_NAV'] === '0' && file_exists($pluginPath . 'Emby_Streams.page')) {
    @rename($pluginPath . 'Emby_Streams.page', $pluginPath . 'Emby_Streams.page.off');
} else if ($cfg['DISPLAY_NAV'] === '1' && file_exists($pluginPath . 'Emby_Streams.page.off')) {
    @rename($pluginPath . 'Emby_Streams.page.off', $pluginPath . 'Emby_Streams.page');
}

// Get CSRF token
$csrf_token = $_SESSION['embystreams_csrf'];
?>

<form markdown="1" name="embystreams_settings" id="embystreams_settings" method="POST" action="/update.php" target="progressFrame" onsubmit="return validateEmbySettings();">
<input type="hidden" name="#file" value="embystreams/embystreams.cfg" />
<input type="hidden" name="csrf_token" value="<?php echo htmlspecialchars($csrf_token, ENT_QUOTES, 'UTF-8'); ?>" />

<div>
    _(Emby Host IP)_:
    <input type="text" 
           name="HOST" 
           id="emby_host"
           value="<?php echo htmlspecialchars($cfg['HOST'], ENT_QUOTES, 'UTF-8'); ?>" 
           placeholder="192.168.1.50" 
           required 
           pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$"
           title="Enter a valid IP address or hostname"
           style="width: 200px;">
    
    _(Port)_:
    <input type="number" 
           name="PORT" 
           id="emby_port"
           value="<?php echo (int)$cfg['PORT']; ?>" 
           placeholder="8096" 
           min="1" 
           max="65535" 
           required
           style="width: 80px;">
</div>

<div>
    _(Use HTTPS)_:
    <input type="radio" name="USE_HTTPS" id="USE_HTTPS_ON" value="1" <?php echo($cfg['USE_HTTPS'] === "1" ? "checked" : ""); ?>/>_(On)_
    <input type="radio" name="USE_HTTPS" id="USE_HTTPS_OFF" value="0" <?php echo($cfg['USE_HTTPS'] === "0" ? "checked" : ""); ?>/>_(Off)_
    <br>
    <span class="desc">_(Enable if using HTTPS/SSL for Emby server)_</span>
</div>

<div>
    _(API Key)_:
    <input type="password" 
           name="API_KEY" 
           id="emby_api_key"
           value="<?php echo htmlspecialchars($cfg['API_KEY'], ENT_QUOTES, 'UTF-8'); ?>" 
           pattern="[a-zA-Z0-9]{32,}"
           title="API key should be at least 32 alphanumeric characters"
           style="width: 300px;">
    <br>
    <span class="desc">_(Generate this in Emby Dashboard > Advanced > API Keys)_</span>
</div>

<div>
    _(Refresh Interval)_:
    <input type="number" 
           name="POLL_INTERVAL" 
           id="emby_poll"
           value="<?php echo (int)$cfg['POLL_INTERVAL']; ?>" 
           min="1" 
           max="60" 
           required
           style="width: 50px;"> _(seconds)_
    <br>
    <span class="desc">_(Minimum: 1 second, Maximum: 60 seconds)_</span>
</div>

<input type="submit" value="SAVE">

</form>

<script>
function validateEmbySettings() {
    var host = document.getElementById('emby_host').value.trim();
    var port = parseInt(document.getElementById('emby_port').value);
    var apiKey = document.getElementById('emby_api_key').value.trim();
    var pollInterval = parseInt(document.getElementById('emby_poll').value);
    
    // Validate host (IP or hostname)
    var ipPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    var hostnamePattern = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
    
    if (!ipPattern.test(host) && !hostnamePattern.test(host)) {
        alert('Please enter a valid IP address or hostname');
        return false;
    }
    
    // Validate port range
    if (port < 1 || port > 65535) {
        alert('Port must be between 1 and 65535');
        return false;
    }
    
    // Validate API key format (basic check)
    if (apiKey && apiKey.length < 32) {
        alert('API key appears to be too short. Please verify it is correct.');
        return false;
    }
    
    // Validate poll interval
    if (pollInterval < 1 || pollInterval > 60) {
        alert('Refresh interval must be between 1 and 60 seconds');
        return false;
    }
    
    return true;
}
</script>

<?endif;?>
