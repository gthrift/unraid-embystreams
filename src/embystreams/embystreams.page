Menu="Settings"
Title="Emby Streams"
Icon="embystreams.png"
---
<?PHP
/* Copyright 2025
 *
 * EmbyStreams - Settings Page
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 */

$plugin = "embystreams";
$docroot = $docroot ?? $_SERVER['DOCUMENT_ROOT'] ?: '/usr/local/emhttp';

require_once("{$docroot}/plugins/{$plugin}/include/helpers.php");

// Load configuration
$cfg = embystreams_getConfig();
?>

<link type="text/css" rel="stylesheet" href="<?autov("/webGui/styles/default-fonts.css")?>">
<link type="text/css" rel="stylesheet" href="<?autov("/webGui/styles/default-popup.css")?>">

<style>
.embystreams-settings {
    max-width: 800px;
}

.embystreams-settings table {
    width: 100%;
    border-collapse: collapse;
}

.embystreams-settings td {
    padding: 10px 12px;
    vertical-align: middle;
}

.embystreams-settings td:first-child {
    width: 200px;
    font-weight: bold;
}

.embystreams-settings input[type="text"],
.embystreams-settings input[type="password"],
.embystreams-settings input[type="number"],
.embystreams-settings select {
    width: 350px;
    padding: 8px;
    border: 1px solid var(--border-color, #ccc);
    border-radius: 4px;
}

.embystreams-settings .help-text {
    color: var(--text-secondary, #666);
    font-size: 0.9em;
    margin-top: 4px;
}

.embystreams-settings .section-header {
    background: var(--header-background, #f0f0f0);
    font-weight: bold;
    padding: 12px;
    margin-top: 20px;
    border-radius: 4px;
}

.embystreams-settings .button-row {
    padding-top: 20px;
    border-top: 1px solid var(--border-color, #ccc);
    margin-top: 20px;
}

.embystreams-settings .test-result {
    display: inline-block;
    margin-left: 15px;
    padding: 6px 12px;
    border-radius: 4px;
    font-weight: bold;
}

.embystreams-settings .test-result.success {
    background: #e8f5e9;
    color: #2e7d32;
}

.embystreams-settings .test-result.error {
    background: #ffebee;
    color: #c62828;
}

.embystreams-settings .test-result.loading {
    background: #fff3e0;
    color: #ef6c00;
}

.embystreams-preview {
    margin-top: 30px;
    padding: 20px;
    background: var(--card-background, #fff);
    border: 1px solid var(--border-color, #ddd);
    border-radius: 8px;
}

.embystreams-preview h3 {
    margin: 0 0 15px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color, #ddd);
}

.embystreams-preview .no-streams {
    color: var(--text-secondary, #666);
    font-style: italic;
    text-align: center;
    padding: 20px;
}

.embystreams-preview .stream-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin: 5px 0;
    background: var(--row-background, #f9f9f9);
    border-radius: 4px;
}

.embystreams-preview .stream-thumb {
    width: 80px;
    height: 45px;
    object-fit: cover;
    border-radius: 4px;
    margin-right: 15px;
    background: #333;
}

.embystreams-preview .stream-info {
    flex: 1;
}

.embystreams-preview .stream-title {
    font-weight: bold;
    margin-bottom: 4px;
}

.embystreams-preview .stream-meta {
    font-size: 0.85em;
    color: var(--text-secondary, #666);
}

.embystreams-preview .stream-status {
    text-align: right;
}

.embystreams-preview .stream-progress {
    width: 100px;
    height: 6px;
    background: var(--border-color, #ddd);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 5px;
}

.embystreams-preview .stream-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4caf50, #8bc34a);
    transition: width 0.3s ease;
}
</style>

<div class="embystreams-settings">
    <form id="embystreams-form" method="POST" autocomplete="off">
        
        <div class="section-header">
            <i class="fa fa-server"></i> _(Emby Server Connection)_
        </div>
        
        <table>
            <tr>
                <td>_(Emby Server URL)_:</td>
                <td>
                    <input type="text" name="EMBY_URL" id="emby_url" 
                           value="<?=htmlspecialchars($cfg['EMBY_URL'])?>" 
                           placeholder="http://192.168.1.100:8096">
                    <div class="help-text">_(Full URL to your Emby server including port)_</div>
                </td>
            </tr>
            <tr>
                <td>_(API Key)_:</td>
                <td>
                    <input type="password" name="EMBY_API_KEY" id="emby_api_key"
                           value="<?=htmlspecialchars($cfg['EMBY_API_KEY'])?>"
                           placeholder="Your Emby API key">
                    <div class="help-text">
                        _(Generate at: Emby Dashboard → Settings → Advanced → API Keys)_
                    </div>
                </td>
            </tr>
            <tr>
                <td></td>
                <td>
                    <input type="button" id="test-connection" value="_(Test Connection)_">
                    <span id="test-result" class="test-result" style="display: none;"></span>
                </td>
            </tr>
        </table>
        
        <div class="section-header">
            <i class="fa fa-cog"></i> _(Display Settings)_
        </div>
        
        <table>
            <tr>
                <td>_(Refresh Interval)_:</td>
                <td>
                    <input type="number" name="REFRESH_INTERVAL" 
                           value="<?=htmlspecialchars($cfg['REFRESH_INTERVAL'])?>" 
                           min="5" max="300">
                    <span>_(seconds)_</span>
                    <div class="help-text">_(How often to update the stream list (5-300 seconds))_</div>
                </td>
            </tr>
            <tr>
                <td>_(Show Thumbnails)_:</td>
                <td>
                    <select name="SHOW_THUMBNAILS">
                        <option value="yes" <?=$cfg['SHOW_THUMBNAILS']==='yes'?'selected':''?>>_(Yes)_</option>
                        <option value="no" <?=$cfg['SHOW_THUMBNAILS']==='no'?'selected':''?>>_(No)_</option>
                    </select>
                    <div class="help-text">_(Display media thumbnails in stream list)_</div>
                </td>
            </tr>
            <tr>
                <td>_(Show Transcode Info)_:</td>
                <td>
                    <select name="SHOW_TRANSCODE_INFO">
                        <option value="yes" <?=$cfg['SHOW_TRANSCODE_INFO']==='yes'?'selected':''?>>_(Yes)_</option>
                        <option value="no" <?=$cfg['SHOW_TRANSCODE_INFO']==='no'?'selected':''?>>_(No)_</option>
                    </select>
                    <div class="help-text">_(Show transcoding details for each stream)_</div>
                </td>
            </tr>
            <tr>
                <td>_(Max Streams)_:</td>
                <td>
                    <input type="number" name="MAX_STREAMS" 
                           value="<?=htmlspecialchars($cfg['MAX_STREAMS'])?>" 
                           min="0" max="100">
                    <div class="help-text">_(Maximum streams to display (0 = unlimited))_</div>
                </td>
            </tr>
            <tr>
                <td>_(Show Idle Sessions)_:</td>
                <td>
                    <select name="SHOW_IDLE">
                        <option value="no" <?=$cfg['SHOW_IDLE']==='no'?'selected':''?>>_(No)_</option>
                        <option value="yes" <?=$cfg['SHOW_IDLE']==='yes'?'selected':''?>>_(Yes)_</option>
                    </select>
                    <div class="help-text">_(Include sessions that aren't currently playing)_</div>
                </td>
            </tr>
        </table>
        
        <div class="button-row">
            <input type="submit" value="_(Apply)_">
            <input type="button" value="_(Done)_" onclick="done()">
        </div>
    </form>
    
    <!-- Live Preview -->
    <div class="embystreams-preview" id="streams-preview">
        <h3><i class="fa fa-play-circle"></i> _(Current Streams)_</h3>
        <div id="streams-list">
            <div class="no-streams">_(Loading...)_</div>
        </div>
    </div>
</div>

<script>
$(function() {
    'use strict';
    
    const ajaxUrl = '/plugins/<?=$plugin?>/include/ajax.php';
    let refreshTimer = null;
    
    // Test connection button
    $('#test-connection').on('click', function() {
        const $btn = $(this);
        const $result = $('#test-result');
        const url = $('#emby_url').val().trim();
        const apiKey = $('#emby_api_key').val().trim();
        
        if (!url || !apiKey) {
            $result.removeClass('success loading').addClass('error')
                   .text('<?=_("URL and API Key required")?>').show();
            return;
        }
        
        $btn.prop('disabled', true);
        $result.removeClass('success error').addClass('loading')
               .text('<?=_("Testing...")?>').show();
        
        $.post(ajaxUrl, {
            action: 'testConnection',
            url: url,
            apiKey: apiKey
        })
        .done(function(response) {
            if (response.success) {
                $result.removeClass('loading error').addClass('success')
                       .text('<?=_("Connected to")?> ' + response.server + ' (v' + response.version + ')');
            } else {
                $result.removeClass('loading success').addClass('error')
                       .text(response.message || response.error || '<?=_("Connection failed")?>');
            }
        })
        .fail(function() {
            $result.removeClass('loading success').addClass('error')
                   .text('<?=_("Request failed")?>');
        })
        .always(function() {
            $btn.prop('disabled', false);
        });
    });
    
    // Form submission
    $('#embystreams-form').on('submit', function(e) {
        e.preventDefault();
        
        const formData = $(this).serialize() + '&action=saveConfig';
        
        $.post(ajaxUrl, formData)
        .done(function(response) {
            if (response.success) {
                // Show success message
                addNotification('<?=_("EmbyStreams configuration saved")?>', 'success');
                // Refresh preview
                loadStreams();
            } else {
                addNotification(response.error || '<?=_("Failed to save")?>', 'error');
            }
        })
        .fail(function() {
            addNotification('<?=_("Request failed")?>', 'error');
        });
    });
    
    // Load streams preview
    function loadStreams() {
        const $list = $('#streams-list');
        
        $.get(ajaxUrl, { action: 'getSessions' })
        .done(function(response) {
            if (!response.configured) {
                $list.html('<div class="no-streams"><?=_("Please configure Emby server connection above")?></div>');
                return;
            }
            
            if (!response.success) {
                $list.html('<div class="no-streams" style="color: #c62828;">' + 
                          (response.error || '<?=_("Failed to load streams")?>') + '</div>');
                return;
            }
            
            if (response.sessions.length === 0) {
                $list.html('<div class="no-streams"><?=_("No active streams")?></div>');
                return;
            }
            
            let html = '';
            response.sessions.forEach(function(session) {
                const statusIcon = session.isPaused ? 'fa-pause' : 'fa-play';
                const statusColor = session.isPaused ? '#ff9800' : '#4caf50';
                
                html += '<div class="stream-item">';
                
                // Thumbnail
                if (session.imageUrl && $('select[name="SHOW_THUMBNAILS"]').val() === 'yes') {
                    html += '<img src="' + session.imageUrl + '" class="stream-thumb" onerror="this.style.display=\'none\'">';
                }
                
                // Info
                html += '<div class="stream-info">';
                html += '<div class="stream-title">' + escapeHtml(session.title) + '</div>';
                html += '<div class="stream-meta">';
                html += '<i class="fa fa-user"></i> ' + escapeHtml(session.userName);
                html += ' &bull; <i class="fa fa-tv"></i> ' + escapeHtml(session.client);
                if (session.quality) {
                    html += ' &bull; ' + escapeHtml(session.quality);
                }
                html += ' &bull; ' + escapeHtml(session.playMethod);
                html += '</div>';
                html += '</div>';
                
                // Status
                html += '<div class="stream-status">';
                html += '<i class="fa ' + statusIcon + '" style="color: ' + statusColor + ';"></i> ';
                html += Math.round(session.progress) + '%';
                html += '<div class="stream-progress">';
                html += '<div class="stream-progress-bar" style="width: ' + session.progress + '%;"></div>';
                html += '</div>';
                html += '</div>';
                
                html += '</div>';
            });
            
            $list.html(html);
        })
        .fail(function() {
            $list.html('<div class="no-streams" style="color: #c62828;"><?=_("Failed to connect")?></div>');
        });
    }
    
    // Auto-refresh
    function startAutoRefresh() {
        const interval = parseInt($('input[name="REFRESH_INTERVAL"]').val()) || 10;
        
        if (refreshTimer) {
            clearInterval(refreshTimer);
        }
        
        refreshTimer = setInterval(loadStreams, interval * 1000);
    }
    
    // Helper functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function addNotification(message, type) {
        // Use Unraid's notification system if available
        if (typeof addAlert === 'function') {
            addAlert(message, type);
        } else {
            alert(message);
        }
    }
    
    function done() {
        location.href = '/Settings';
    }
    
    // Initialize
    loadStreams();
    startAutoRefresh();
    
    // Cleanup on page leave
    $(window).on('beforeunload', function() {
        if (refreshTimer) {
            clearInterval(refreshTimer);
        }
    });
});
</script>
