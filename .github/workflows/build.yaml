name: Build Plugin Release

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2026.01.01)'
        required: true
      release_notes:
        description: 'Release notes (use \n for new lines)'
        required: false
        default: '- Bug fixes and improvements'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#v}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"
      
      - name: Build txz package
        id: build
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PLUGIN_NAME="embystreams"
          
          echo "Building ${PLUGIN_NAME} version ${VERSION}..."
          
          # Create directories
          mkdir -p archive
          TEMP_DIR=$(mktemp -d)
          PLUGIN_DIR="${TEMP_DIR}/usr/local/emhttp/plugins/${PLUGIN_NAME}"
          mkdir -p "${PLUGIN_DIR}"
          
          # --- COPY FILES ---
          # Use -v to see what is happening in the logs
          # We copy EVERYTHING in src/ to catch hidden .sh files or subfolders
          cp -r -v src/* "${PLUGIN_DIR}/" 2>/dev/null || true
          cp -v metadata/*.png "${PLUGIN_DIR}/" 2>/dev/null || true

          # --- FIX PERMISSIONS (CRITICAL FOR UNRAID) ---
          echo "Setting permissions..."
          # Directories: 755 (rwxr-xr-x) - allows traversal
          find "${TEMP_DIR}" -type d -exec chmod 755 {} \;
          # Files: 644 (rw-r--r--) - allows WebGUI/PHP to read theme
          find "${TEMP_DIR}" -type f -exec chmod 644 {} \;
          
          # If you have executable scripts (like .sh), make them executable:
          # find "${PLUGIN_DIR}" -name "*.sh" -exec chmod 755 {} \;
          
          # --- CLEANUP ---
          # Remove Mac metadata files if they exist (prevents garbage in plugin)
          find "${TEMP_DIR}" -name "._*" -delete

          # --- VERIFICATION ---
          FILE_COUNT=$(find "${PLUGIN_DIR}" -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "ERROR: No files were copied to ${PLUGIN_DIR}"
            exit 1
          fi
          
          echo "Files included in package:"
          find "${PLUGIN_DIR}" -type f
          
          # --- CREATE ARCHIVE ---
          ARCHIVE_NAME="${PLUGIN_NAME}-${VERSION}.txz"
          echo "Creating archive: ${ARCHIVE_NAME}"
          
          cd "${TEMP_DIR}"
          # FORCE ROOT OWNERSHIP HERE
          tar --owner=0 --group=0 -cJf "${GITHUB_WORKSPACE}/archive/${ARCHIVE_NAME}" .
          cd "${GITHUB_WORKSPACE}"
          
          # Generate SHA256 (preferred for security over MD5)
          SHA256_HASH=$(sha256sum "archive/${ARCHIVE_NAME}" | awk '{print $1}')
          echo "${SHA256_HASH}" > "archive/${PLUGIN_NAME}-${VERSION}.sha256"

          # Output env vars
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV
          echo "SHA256_HASH=${SHA256_HASH}" >> $GITHUB_ENV
          
          echo "Archive created: ${ARCHIVE_NAME}"
          echo "SHA256: ${SHA256_HASH}"
          
          rm -rf "${TEMP_DIR}"
      
      - name: Update plg file with new version, SHA256, and release notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          RELEASE_NOTES="${{ github.event.inputs.release_notes }}"
          
          echo "Updating embystreams.plg..."
          echo "  Version: ${VERSION}"
          echo "  SHA256: ${SHA256_HASH}"

          # Update version in plg file
          sed -i 's/<!ENTITY version[[:space:]]*"[^"]*"/<!ENTITY version   "'"${VERSION}"'"/' embystreams.plg

          # Update SHA256 - handle both existing and missing entity
          if grep -q "<!ENTITY sha256" embystreams.plg; then
              # Update existing sha256 entity
              sed -i 's/<!ENTITY sha256[[:space:]]*"[^"]*"/<!ENTITY sha256    "'"${SHA256_HASH}"'"/' embystreams.plg
              echo "  Updated existing SHA256 entity"
          else
              # Insert new sha256 entity after archive entity
              sed -i '/<!ENTITY archive/a <!ENTITY sha256    "'"${SHA256_HASH}"'">' embystreams.plg
              echo "  Inserted new SHA256 entity"
          fi
          
          # Verify the update worked
          if ! grep -q "${SHA256_HASH}" embystreams.plg; then
              echo "ERROR: SHA256 hash not found in PLG file after update!"
              exit 1
          fi
          
          # Add release notes if provided (for manual triggers only)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${RELEASE_NOTES}" ]; then
            echo "  Adding release notes..."

            # Convert \n to actual newlines
            FORMATTED_NOTES=$(printf '%s' "${RELEASE_NOTES}" | sed 's/\\n/\n/g')

            # Create the new changelog entry in a temp file to avoid sed escaping issues
            TEMP_FILE=$(mktemp)
            printf '###%s\n%s\n\n' "${VERSION}" "${FORMATTED_NOTES}" > "${TEMP_FILE}"

            # Use awk to insert content after <CHANGES> tag (more robust than sed for this use case)
            awk '
            /<CHANGES>/ {
                print
                while ((getline line < "'"${TEMP_FILE}"'") > 0) {
                    print line
                }
                close("'"${TEMP_FILE}"'")
                next
            }
            {print}
            ' embystreams.plg > embystreams.plg.tmp && mv embystreams.plg.tmp embystreams.plg

            rm "${TEMP_FILE}"

            echo "  Release notes added"
          fi
          
          echo ""
          echo "Updated plg file (DOCTYPE section):"
          sed -n '/<!DOCTYPE PLUGIN/,/]>/p' embystreams.plg
          
          echo ""
          echo "Updated plg file (CHANGES section):"
          grep -A 10 "<CHANGES>" embystreams.plg | head -15
      
      - name: Validate PLG file
        run: |
          echo "Validating PLG XML syntax..."
          
          # Check if xmllint is available
          if command -v xmllint &> /dev/null; then
              xmllint --noout embystreams.plg
              echo "✓ XML syntax is valid"
              
              # Check entity resolution
              echo ""
              echo "Entity resolution test:"
              xmllint --noent embystreams.plg | grep -A 2 "<SHA256>"
          else
              echo "xmllint not available, skipping XML validation"
          fi
          
          # Verify entities are present
          echo ""
          echo "Checking required entities..."
          
          MISSING_ENTITIES=""
          
          if ! grep -q "<!ENTITY version" embystreams.plg; then
              MISSING_ENTITIES="${MISSING_ENTITIES}version "
          fi
          
          if ! grep -q "<!ENTITY sha256" embystreams.plg; then
              MISSING_ENTITIES="${MISSING_ENTITIES}sha256 "
          fi
          
          if ! grep -q "<!ENTITY archive" embystreams.plg; then
              MISSING_ENTITIES="${MISSING_ENTITIES}archive "
          fi
          
          if [ -n "$MISSING_ENTITIES" ]; then
              echo "ERROR: Missing entities: ${MISSING_ENTITIES}"
              exit 1
          fi
          
          echo "✓ All required entities present"
          
          # Check for duplicate closing tags
          PLUGIN_CLOSE_COUNT=$(grep -c "</PLUGIN>" embystreams.plg)
          if [ "$PLUGIN_CLOSE_COUNT" -gt 1 ]; then
              echo "WARNING: Found ${PLUGIN_CLOSE_COUNT} </PLUGIN> tags (should be 1)"
              echo "This may cause installation issues"
          else
              echo "✓ No duplicate closing tags"
          fi
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add archive/ embystreams.plg
          
          # Commit (don't fail if no changes)
          git diff --staged --quiet && echo "No changes to commit" || git commit -m "Build version ${{ steps.version.outputs.VERSION }}"
          
          # Push changes
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
   
