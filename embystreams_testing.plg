<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
<!ENTITY name      "embystreams">
<!ENTITY author    "gthrift">
<!ENTITY version   "2026.02.01">
<!ENTITY launch    "Settings/EmbyStreamsSettings">
<!ENTITY gitURL    "https://raw.githubusercontent.com/gthrift/unraid-embystreams/2026.02.02">
<!ENTITY pluginURL "&gitURL;/embystreams_testing.plg">
<!ENTITY emhttp    "/usr/local/emhttp/plugins/&name;">
<!ENTITY plgPATH   "/boot/config/plugins/&name;">
]>

<PLUGIN name="&name;"
        author="&author;" 
        version="&version;" 
        launch="&launch;" 
        pluginURL="&pluginURL;" 
        support="https://github.com/gthrift/unraid-embystreams/issues"
        project="https://github.com/gthrift/unraid-embystreams/"
        readme="https://github.com/gthrift/unraid-embystreams/#readme"
        icon="emby.png">

<CHANGES>
###2026.02.01
- Testing Release (Switched to 'main' branch).
</CHANGES>

<OVERVIEW>
A plugin to create a dashboard widget that shows your active Emby streams (Testing Branch)
</OVERVIEW>

<FILE Name="&emhttp;/EmbyStreamsSettings.page">
<URL>&gitURL;/src/EmbyStreamsSettings.page</URL>
</FILE>

<FILE Name="&emhttp;/EmbyStreams.page">
<URL>&gitURL;/src/EmbyStreams.page</URL>
</FILE>

<FILE Name="&emhttp;/embystreams_api.php">
<URL>&gitURL;/src/embystreams_api.php</URL>
</FILE>

<FILE Name="&emhttp;/emby.png">
<URL>&gitURL;/metadata/emby.png</URL>
</FILE>

<FILE Run="/bin/bash">
<INLINE>
# 1. Create Config Directory
mkdir -p "&plgPATH;"

# 2. Set Default Config if missing
if [ ! -f "&plgPATH;/embystreams.cfg" ]; then
    echo "HOST=''" > "&plgPATH;/embystreams.cfg"
    echo "PORT='8096'" >> "&plgPATH;/embystreams.cfg"
    echo "API_KEY=''" >> "&plgPATH;/embystreams.cfg"
    echo "POLL_INTERVAL='5'" >> "&plgPATH;/embystreams.cfg"
    echo "DISPLAY_WIDGET='1'" >> "&plgPATH;/embystreams.cfg"
    echo "DISPLAY_NAV='1'" >> "&plgPATH;/embystreams.cfg"
    echo "USE_HTTPS='0'" >> "&plgPATH;/embystreams.cfg"
fi

# 3. TOGGLE LOGIC (Hide/Show Dashboard Widget based on config)
CFG_FILE="&plgPATH;/embystreams.cfg"
WIDGET_FILE="&emhttp;/EmbyStreams.page"

if [ -f "$CFG_FILE" ]; then
    source "$CFG_FILE"
fi

DISPLAY_WIDGET="${DISPLAY_WIDGET:-1}"

if [ "$DISPLAY_WIDGET" == "0" ]; then
    if [ -f "$WIDGET_FILE" ]; then
        mv "$WIDGET_FILE" "$WIDGET_FILE.off"
    fi
else
    if [ -f "$WIDGET_FILE.off" ]; then
        mv "$WIDGET_FILE.off" "$WIDGET_FILE"
    fi
fi

echo ""
echo "-----------------------------------------------------------"
echo " &name; (Testing) has been installed."
echo " Version: &version;"
echo "-----------------------------------------------------------"
echo ""
</INLINE>
</FILE>

<FILE Run="/bin/bash" Method="remove">
<INLINE>
echo "Uninstalling &name;..."

# 1. Remove WebUI files
rm -rf "&emhttp;"

# 2. Remove the PLG file itself
# Corrects the path to the root plugins folder
rm -f "/boot/config/plugins/embystreams_testing.plg"
rm -f "/boot/config/plugins/embystreams.plg"

echo ""
echo "-----------------------------------------------------------"
echo " &name; has been uninstalled."
echo "-----------------------------------------------------------"
echo ""
</INLINE>
</FILE>

</PLUGIN>
